<!-- app/views/products/show.html.erb -->

<div class="product-page-container">

  <!-- Sticky header: product name | supplier name | status -->
  <div class="wrapper-that-freezes-things">
    <div class="products-header">
      <!-- Product name -->
      <h1 class="product-title"><%= @product.name %></h1>

      <!-- Supplier name (same styling as product-title) -->
      <% if (s = @product.supplier) %>
        <h1 class="product-title"><%= s.company_name %></h1>
      <% else %>
        <h1 class="product-title text-gray-500">Unknown Supplier</h1>
      <% end %>

      <!-- Status -->
      <h1 class="product-title">
        <span class="status <%= @product.display_status_css_class(current_user) %>">
          <%= @product.display_status_for_user(current_user) %>
        </span>
      </h1>
    </div>
  </div>

  <!-- Detail card -->
  <div class="card-wrapper">
    <div class="card-pro">
      <hr>

      <!-- Supplier email -->
      <% if s && s.contact_email.present? %>
        <p class="card-pro__content">
          <strong>Email:</strong>
          <%= mail_to s.contact_email, s.contact_email, class: "product-email-link" %>
        </p>
      <% end %>

      <!-- Description -->
      <p class="card-pro__content">
        <strong>Description:</strong><br>
        <%= @product.description.presence || "No description available." %>
      </p>

      <!-- Contract details -->
      <p class="card-pro__content">
        <strong>Current Price:</strong> <%= number_to_currency(@product.current_price) %><br>
        <strong>Ends:</strong>          <%= l(@product.contract_end_date) %>
      </p>

      <!-- Purchase volumes -->
      <p class="card-pro__content">
        <strong>Last 30 days:</strong>   <%= @product.last_month_volume %> units<br>
        <strong>Last 12 months:</strong> <%= @product.last_year_volume  %> units
      </p>

      <!-- Renegotiate button -->
      <div class="card-pro__actions">
        <% if @product.renegotiation_allowed?(current_user) %>
          <%= link_to "Renegotiate",
                      new_product_renegotiation_path(@product),
                      class: "import-btn" %>
        <% elsif @product.has_ongoing_renegotiation?(current_user) %>
          <% ongoing_renegotiation = @product.renegotiations
                                            .joins(:buyer)
                                            .find_by(users: { company_name: current_user.company_name }, 
                                                    status: "Ongoing") %>
          <%= link_to "Continue Renegotiation",
                      confirm_target_renegotiation_path(ongoing_renegotiation),
                      class: "import-btn" %>
        <% elsif @product.contract_expiring_soon? %>
          <span class="import-btn disabled" style="background-color: #666; cursor: not-allowed;">
            Renegotiation in progress
          </span>
        <% else %>
          <span class="import-btn disabled" style="background-color: #666; cursor: not-allowed;">
            Review on <%= @product.next_review_date&.strftime("%d.%m.%Y") %>
          </span>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Back to results -->
  <div class="text-center" style="margin-top: 1.5rem;">
    <%= link_to "← Back to results",
                products_path,
                class: "import-btn" %>
  </div>

</div>
